worker_processes auto;
worker_rlimit_nofile 65535;
error_log /dev/stderr warn;
pid /tmp/nginx.pid;

# Thread pool for async I/O
thread_pool default threads=32 max_queue=65536;

events {
    worker_connections 16384;
    use epoll;
    multi_accept on;
}

http {
    include       /nix/store/q1qasxldhc1g6zwcxbpj7h7nr3bxcvgy-nginx-1.28.0/conf/mime.types;
    default_type  application/octet-stream;

    

    # ═══════════════════════════════════════════════════════════════
    # Performance tuning (global)
    # ═══════════════════════════════════════════════════════════════
    sendfile           on;
    tcp_nopush         on;      # Fill packets before sending (throughput)
    keepalive_timeout  30;      # Reduced for HLS polling (frees connections faster)
    keepalive_requests 10000;

    # Free memory faster from dirty client exits
    reset_timedout_connection on;

    # File descriptor caching (reduces stat() syscalls)
    open_file_cache          max=10000 inactive=30s;
    open_file_cache_valid    10s;
    open_file_cache_min_uses 1;
    open_file_cache_errors   on;

    sendfile_max_chunk 512k;
    access_log off;
    gzip off;  # .ts files are already compressed

    # Client body buffer (HLS origins don't accept POST)
    client_body_buffer_size 128k;

    # ═══════════════════════════════════════════════════════════════
    # Async I/O for high-load scenarios
    # Optimized for small HLS segments (2-4MB) on fast storage
    # directio 4m: Only use direct I/O for files > 4MB
    # This allows OS page cache to serve hot .m3u8 and .ts files
    # ═══════════════════════════════════════════════════════════════
    aio            threads=default;
    directio       4m;  # Only use direct I/O for files > 4MB (allows page cache for segments)

    server {
        listen 17080 reuseport;
        server_name _;
        root /var/hls;

        # ═══════════════════════════════════════════════════════════
        # Security: Method filtering (HLS origins only need GET/HEAD/OPTIONS)
        # ═══════════════════════════════════════════════════════════
        if ($request_method !~ ^(GET|HEAD|OPTIONS)$ ) {
            return 405;
        }

        # ═══════════════════════════════════════════════════════════
        # Master playlist (ABR entry point)
        # - Rarely changes unless variants added/removed
        # - tcp_nodelay for immediate delivery
        # ═══════════════════════════════════════════════════════════
        location = /master.m3u8 {
            tcp_nodelay    on;  # Immediate delivery
            add_header Cache-Control "public, max-age=5, stale-while-revalidate=10, no-transform";
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Expose-Headers "Content-Length";
            types { application/vnd.apple.mpegurl m3u8; }
        }

        # ═══════════════════════════════════════════════════════════
        # Variant playlists (.m3u8)
        # - Updates every 2s
        # - TTL = 1s, SWR = 2s
        # - tcp_nodelay for freshness over throughput
        # ═══════════════════════════════════════════════════════════
        location ~ \.m3u8$ {
            access_log off;
            tcp_nodelay    on;  # Immediate delivery for freshness
            add_header Cache-Control "public, max-age=1, stale-while-revalidate=2, no-transform";
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Expose-Headers "Content-Length";
            types { application/vnd.apple.mpegurl m3u8; }
        }

        # ═══════════════════════════════════════════════════════════
        # Segments (.ts)
        # - Immutable once written
        # - Segment lifetime: 30s
        # - Cache TTL: 60s (generous, safe)
        # - tcp_nopush for throughput (fill packets)
        # ═══════════════════════════════════════════════════════════
        location ~ \.ts$ {
            access_log off;
            sendfile       on;
            tcp_nopush     on;   # Fill packets for throughput
            aio            threads;
            add_header Cache-Control "public, max-age=60, immutable, no-transform";
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Expose-Headers "Content-Length,Content-Range";
            add_header Accept-Ranges bytes;
            types { video/mp2t ts; }
        }

        # ═══════════════════════════════════════════════════════════
        # Health check
        # ═══════════════════════════════════════════════════════════
        location /health {
            return 200 "OK\n";
            add_header Content-Type text/plain;
            add_header Cache-Control "no-store";
        }

        # ═══════════════════════════════════════════════════════════
        # Metrics (for monitoring/observability)
        # ═══════════════════════════════════════════════════════════
        location /nginx_status {
            stub_status on;
            access_log off;
            add_header Cache-Control "no-store";
        }

        # ═══════════════════════════════════════════════════════════
        # CORS preflight
        # ═══════════════════════════════════════════════════════════
        location / {
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin "*";
                add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
                add_header Access-Control-Allow-Headers "Range";
                add_header Access-Control-Max-Age 86400;
                add_header Content-Length 0;
                return 204;
            }
        }
    }
}
