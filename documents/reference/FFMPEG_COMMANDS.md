# FFmpeg Commands Reference

> **Type**: Reference Documentation
> **Source**: Verified against `internal/process/ffmpeg.go`

This document describes the FFmpeg commands generated by go-ffmpeg-hls-swarm for HLS streaming.

---

## Basic Command Structure

```bash
ffmpeg -hide_banner -nostdin -loglevel <level> [options] -i <url> -map <selection> -c copy -f null -
```

### Components

| Component | Purpose |
|-----------|---------|
| `-hide_banner` | Suppress FFmpeg version banner |
| `-nostdin` | Disable stdin (non-interactive) |
| `-loglevel` | Control output verbosity |
| `-i <url>` | Input HLS stream URL |
| `-map` | Select streams to process |
| `-c copy` | Copy streams without re-encoding |
| `-f null -` | Discard output (measurement only) |

---

## Log Levels

### Standard Modes

| Level | Description |
|-------|-------------|
| `error` | Only errors |
| `warning` | Errors and warnings |
| `info` | Default, progress information |
| `verbose` | More detailed information |
| `debug` | Full debug output |

### Stats Mode (when `-stats` enabled)

When stats collection is enabled, the log level becomes:

```
repeat+level+datetime+debug
```

This provides:
- **repeat**: Don't collapse repeated messages
- **level**: Add [debug]/[verbose] tags for filtering
- **datetime**: Millisecond-precision timestamps
- **debug**: Full segment and manifest timing

---

## Progress Output

When stats are enabled, progress is written to a separate file descriptor:

```bash
-progress pipe:3 -stats_period 1
```

This outputs key-value pairs every second:
```
frame=450
fps=30.0
stream_0_0_q=-1.0
bitrate=2500kbits/s
total_size=5242880
out_time_us=15000000
out_time_ms=15000
out_time=00:00:15.000000
dup_frames=0
drop_frames=0
speed=1.00x
progress=continue
```

---

## Reconnection Options

When `-reconnect` is enabled:

```bash
-reconnect 1 \
-reconnect_streamed 1 \
-reconnect_on_network_error 1 \
-reconnect_delay_max 5
```

| Option | Description |
|--------|-------------|
| `-reconnect 1` | Enable reconnection |
| `-reconnect_streamed 1` | Reconnect for streaming protocols |
| `-reconnect_on_network_error 1` | Reconnect on network failures |
| `-reconnect_delay_max 5` | Max delay between reconnects (seconds) |

---

## Network Options

### Timeout

```bash
-rw_timeout 15000000
```

Network read/write timeout in microseconds (default: 15s = 15000000).

### Segment Retry

```bash
-seg_max_retry 3
```

Number of times to retry segment downloads on failure.

---

## User Agent

```bash
-user_agent "go-ffmpeg-hls-swarm/1.0/client-42"
```

Format: `<base_user_agent>/client-<id>`

Enables correlation with origin logs:
- tcpdump: `tcpdump -A | grep "client-42"`
- Wireshark: `http.user_agent contains "client-42"`
- Nginx: `grep "client-42" access.log`

---

## HTTP Headers

### Cache Bypass (-no-cache)

```bash
-headers "Cache-Control: no-cache, no-store, must-revalidate\r\nPragma: no-cache\r\n"
```

### IP Override (-resolve)

```bash
-headers "Host: original.cdn.com\r\n"
```

The `Host:` header preserves the original hostname when connecting to a specific IP.

### Custom Headers (-header)

```bash
-headers "X-Test-ID: load-test-001\r\nX-Client: swarm\r\n"
```

---

## TLS Options

When `-resolve` with `--dangerous`:

```bash
-tls_verify 0
```

Disables certificate verification for IP override scenarios.

---

## Stream Selection

### All Variants (-variant all)

```bash
-map 0
```

Maps all streams from input. Maximum bandwidth usage.

### First Variant (-variant first)

```bash
-map 0:v:0? -map 0:a:0?
```

Maps first video and first audio stream. The `?` makes it optional (no error if missing).

### Highest/Lowest Variant (-variant highest/lowest)

```bash
-map 0:p:2
```

Maps specific program ID determined by ffprobe. Fallback to first variant if probe fails.

---

## Complete Example Commands

### Simple Load Test

```bash
ffmpeg -hide_banner -nostdin -loglevel info \
  -reconnect 1 -reconnect_streamed 1 -reconnect_on_network_error 1 \
  -reconnect_delay_max 5 \
  -rw_timeout 15000000 \
  -user_agent "go-ffmpeg-hls-swarm/1.0/client-1" \
  -seg_max_retry 3 \
  -i "https://example.com/stream.m3u8" \
  -map 0 \
  -c copy -f null -
```

### With Stats Collection

```bash
ffmpeg -hide_banner -nostdin \
  -loglevel repeat+level+datetime+debug \
  -progress pipe:3 -stats_period 1 \
  -reconnect 1 -reconnect_streamed 1 -reconnect_on_network_error 1 \
  -reconnect_delay_max 5 \
  -rw_timeout 15000000 \
  -user_agent "go-ffmpeg-hls-swarm/1.0/client-1" \
  -seg_max_retry 3 \
  -i "https://example.com/stream.m3u8" \
  -map 0 \
  -c copy -f null -
```

### With IP Override

```bash
ffmpeg -hide_banner -nostdin -loglevel info \
  -tls_verify 0 \
  -reconnect 1 -reconnect_streamed 1 -reconnect_on_network_error 1 \
  -reconnect_delay_max 5 \
  -rw_timeout 15000000 \
  -user_agent "go-ffmpeg-hls-swarm/1.0/client-1" \
  -headers "Host: cdn.example.com\r\n" \
  -seg_max_retry 3 \
  -i "https://192.168.1.100/stream.m3u8" \
  -map 0 \
  -c copy -f null -
```

### With Cache Bypass

```bash
ffmpeg -hide_banner -nostdin -loglevel info \
  -reconnect 1 -reconnect_streamed 1 -reconnect_on_network_error 1 \
  -reconnect_delay_max 5 \
  -rw_timeout 15000000 \
  -user_agent "go-ffmpeg-hls-swarm/1.0/client-1" \
  -headers "Cache-Control: no-cache, no-store, must-revalidate\r\nPragma: no-cache\r\n" \
  -seg_max_retry 3 \
  -i "https://cdn.example.com/stream.m3u8" \
  -map 0 \
  -c copy -f null -
```

---

## Debug Output

Use `--print-cmd` to see the exact command that would be run:

```bash
go-ffmpeg-hls-swarm --print-cmd -clients 50 -variant highest \
  https://example.com/stream.m3u8
```
